原文链接:https://bitshares.org/technology/industrial-performance-and-scalability/
译者：bt666

# 工业性能和可扩展性 #

**当我们支付网络费用时，石墨烯性能能够达到100,000 TPS**

对于加密货币和智能合约平台来说，高性能区块链技术是必要的，它可以为现有的金融平台提供一个可行的替代方案。 比特股的设计初衷是为了每秒处理比VISA和MasterCard加起来还要多的交易。 使用委托权益证明机制，比特股网络可以在平均仅1秒钟确认交易，仅受光速的限制。

## 概览 ##

为了实现业界领先的性能，比特股借鉴了LMAX交易所的经验，该交易所能够每秒处理600万笔交易。这些经验中有以下要点:：

1. 把一切存储在内存中。
1. 将核心业务逻辑保留在单个线程中。
1. 将加密操作（哈希和签名）保留在核心业务逻辑之外。
1. 将验证分为状态依赖型检查和状态独立型检查。
1. 使用面向对象的数据模型。

通过遵循这些简单的规则，比特股能够每秒处理100,000个交易，而无需花费大量精力进行优化。预计未来的优化会使比特股的性能达到类似于LMAX的水平。

应该注意的是，比特股实现的性能高度依赖于兼容的交易协议。如果一个协议中的核心业务逻辑在虚拟机中运行，而虚拟机又执行加密操作并使用哈希标识符引用所有对象的话，使用这种协议是不可能达到相同的性能水平的。区块链本质上是单线程的，并且单核CPU的性能是最有限、最不可扩展的资源。 比特股的设计是为了最大限度地利用这个执行线程。

## 背景 ##

区块链是对交易进行排序的全局账本，其中每个交易确定性地修改指定时间戳的共享全局状态。处理交易的顺序可以改变其他交易的有效性。例如，在您的支票存款清算之前，您无法从您的银行帐户中提取资金。在处理完影响特定帐户的所有先前交易之后，才能知道交易是否有效。

理论上，两个不相关帐户的交易可以同时处理，前提是它们不共享任何共同的依赖关系。在实践中，识别在具有任意条件的智能合约授权的账本中哪些交易是真正彼此独立的成本是很难控制的。确保两个交易真正独立的唯一方法是维护完全独立的账本，然后定期在它们之间转移价值。可以与对非均匀存储器访问（NUMA）与均匀存储器访问的设计中的性能折衷进行类比。

在实践中，对于开发人员来说，统一内存访问更容易设计，并且成本更低。在构建超级计算机或巨型集群时，通常采用NUMA架构作为最后的手段。

计算机行业已经逐渐意识到，并行地扩展性能远不如早期那么容易，那时所需要的只是提高CPU的时钟速度。 正是出于这个原因，CPU设计者在尝试采用多线程方法来提高性能之前将单线程性能推向了极限。 当多线程不够时，那时，也只有在那时，集群计算才被认为是一种选择。

加密货币行业中的许多人试图通过立即转向“集群”解决方案来解决可扩展性问题，而没有充分探索单个计算机的单核在技术上的可行性。

## LMAX Disruptor ##

LMAX Disruptor提供了一个对具有高度可扩展性和性能的体系结构的案例研究，展示了在单个执行线程中可实现的功能。 LMAX是一个零售交易平台，目标是成为世界上交易速度最快的交易所。他们非常慷慨地公开分享了他们学到的东西。

以下是对他们架构的简要概述：

业务逻辑处理器是处理所有顺序交易和订单匹配的地方。它是一个单线程，每秒可以处理数百万个订单。这种架构很容易移植到加密货币和区块链设计领域。

输入中断器（Input Disruptor）的作用是收集来自多种不同来源的用户的订单，并为他们分配确定性的订单。在为它们分配订单后，它们会被复制，记录并广播到许多冗余业务逻辑处理器中。输入中断器的任务是令人尴尬的并行的，并且很容易被分配给计算机集群。

在业务逻辑处理器处理完输入后，输出中断器（Output Disruptor）会负责通知任何关心结果的组成部分。这也是一项令人尴尬的并行任务。

最终，LMAX能够使用Java虚拟机使用商用CPU的单核，通过业务逻辑处理器每秒处理600万次交易。如果LMAX每秒可以处理600万次交易，那么当它们甚至每秒都处理不到10次交易时，加密货币和智能合约平台显然就不需要使用集群解决方案。

## 高性能区块链 ##

要实现高性能区块链，比特股必须采用与LMAX相同的技术。必须满足几个关键功能：

- 把一切存储在内存中。
- 避免同步原语（锁，原子操作）。
- 最大限度地减少业务逻辑处理器中不必要的计算。

内存现在变得越来越便宜，因为它在设计上是非常并行化的。追踪互联网上每个人的帐户余额和权限所需的信息量不到1TB的RAM，可以用不到1.5万美元购买，并安装在商用（高端）服务器主板上。早在30亿人采用该系统之前，这种硬件就会出现在普通的台式机上。

真正的瓶颈不是内存要求，而是带宽要求。每秒100万次交易处理，每个交易256字节，网络将需要每秒256兆字节（1 Gbit / sec）的带宽。这种带宽并不普遍适用于普通台式机;然而，这个带宽水平只是互联网2.0为超过210家美国教育机构，70家公司和45家非营利性和政府机构提供的100 Gbit / s的一小部分。

因此，如果设计得当，区块链技术可以轻松地将所有数据保存在RAM中并进行扩展，以便每秒处理数百万个交易。

## 避免使用哈希，而是分配ID ##

在单线程系统中，CPU周期是一种需要保护的稀缺资源。传统的区块链设计使用加密哈希来生成全局唯一的ID，这些ID在统计上保证不会发生冲突。这些哈希的问题在于它们需要更多的内存和CPU周期来进行操作。通过哈希查找帐户记录比直接使用数组索引花费更多的CPU时间。例如，64位整数比160 +位ID更容易比较和操作。哈希ID值越大意味着CPU缓存空间越小，需要更多内存。在现代操作系统上，不经常访问的RAM是被压缩的，但是哈希标识符是不可压缩的随机数据。

幸运的是，区块链为我们提供了一种全局分配彼此不冲突的唯一ID的方法，因此完全可以不使用基于哈希的标识符（比特币地址）来引用帐户，余额或权限。

## 从业务逻辑处理器中删除签名验证 ##

加密货币网络上的所有交易都依赖于加密签名来验证权限。 在一般情况下，所需的权限可能会因其他交易而更改。 这意味着应该用不需要在业务逻辑处理器内进行加密计算的方式来定义权限。

为此，需要为每个公钥分配唯一且不可变的ID。 分配ID后，输入中断器可以验证所提供的签名是否与指定的ID匹配。 当交易到达业务逻辑处理器时，唯一剩下的步骤就是检查ID。

可以使用相同的技术来删除具有静态ID的任何不可变对象的前置条件检查。

## 为静态验证设计交易 ##

可以静态地检查许多交易的属性，而无需引用当前的全局状态。
这些检查包括参数范围检查，输入去重，数组排序等。一般而言，如果交易包括它“假定”烦人关于全局状态的数据，那么就可以执行许多检查。 执行这些检查后，业务逻辑处理器要做的就是确保“假设”仍然正确，这通常可以归结为检查与交易签名时间相关的引用对象的修改时间戳。

## 智能合约 ##

许多区块链采用通用的脚本语言来定义所有操作。这些设计最终将“业务逻辑处理器”定义为虚拟机，所有交易都定义为由虚拟机运行的脚本。这种方法会受到真实CPU的单线程限制，并通过强制性的在虚拟CPU上执行交易来进行调和。虚拟CPU，即使使用即时编译，也总是比真实CPU慢，但纯粹的计算速度并不是“一切都是脚本”方法的唯一问题。

当交易定义在如此低的级别时，这意味着大多数静态检查和加密操作会回到业务逻辑处理中，整体吞吐量下降。即使是通过本机调用，脚本引擎也不应该要求执行加密签名检查。

根据我们从LMAX中学到的经验，我们知道区块链的虚拟机应该考虑单线程性能。这意味着它应该从一开始就对即时编译进行优化，并且区块链本身应该支持最常用的智能合约，只留下很少使用的自定义合约在虚拟机中运行。这些自定义的合约应该围绕性能进行设计，这意味着虚拟机应该将可寻址内存限制在CPU缓存中使用。

## 面向对象的数据模型 ##

将所有内容保存在内存中的好处之一是，可以将软件设计为模拟数据的真实世界关系。 这意味着业务逻辑处理器可以快速跟踪内存中指向所需数据的指针，而不是被迫执行昂贵的数据库查询。 它还意味着可以在不复制数据的情况下访问数据，并且可以就地修改数据。 与使用基于数据库的方法相比，这种优化使得性能有着数量级上的提升。

## 交易大小 ##

每秒处理100,000个交易的区块链会生成大量数据。竞争网络上的交易的平均大小，例如瑞波和比特币，大约是250字节。 比特股上的类似交易平均只有100个字节。换句话说，竞争系统需要2.5倍的带宽来传播相同大小的交易。假设与互联网的千兆位连接，传输包含100,000个交易的块大约只需要0.1秒，而竞争网络需要0.25秒。在考虑到点对点网络上的延迟和多跳之后，很明显交易大小直接影响块的间隔，从而直接导致确认的延迟。

交易大小通常表示CPU必须在其关键路径中处理的数据量。因此，它们可以作为CPU的单线程性能何时被命中的指标。

如果假设所有节点都事先知道所有广播的事务，并且只需要交易id的有序列表来广播每个块，那么可以对所有协议都进行一些优化。这将是一个实现的细节。

## 结论 ##

设计高性能区块链不是火箭科学，不需要复杂、难以理解的协议，也不需要在网络上的所有节点之间进行分割处理。 相反，构建高性能区块链所需的全部工作是从核心业务逻辑中删除非关键的，依赖于顺序的、评估的所有计算，并设计一个协议来实现这些类型的优化。 这就是比特股所做的。