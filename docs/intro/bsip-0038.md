原文链接：https://github.com/bitshares/bsips/blob/master/bsip-0038.md
译者：bt666

    BSIP：0038
    标题：向空头头寸添加目标抵押比率选项
    作者：Abit More <https://github.com/abitmore>
    状态：已安装
    类型：协议
    创建时间：2018-03-05
    讨论：https：//bitsharestalk.org/index.php？topic = 25924.0，
                https://github.com/bitshares/bsips/issues/51
    取代：0035（部分）
    预算提案：1.14.100

## 摘要 ##

当空头头寸作为追加保证金时，其部分抵押将被出售，部分或全部债务将相应地得到偿付。

但是，与维持维护抵押比率（MCR）要求所需的最低销售量相比，通常会售出更多的抵押。

该BSIP建议对协议进行更改，以便让空头（借款人）控制在追加保证金时卖出的抵押数量。

该BSIP依赖于[BSIP 31](https://github.com/bitshares/bsips/blob/master/bsip-0031.md)。

## 动机 ##

正如[本论坛帖子](https://bitsharestalk.org/index.php?topic=25924.0)所讨论的那样，当前的流程让操盘手有很大机会通过做空BTS赚钱，增加黑天鹅的风险，从而伤害BTS生态系统。 许多参与讨论的人都同意，在追加保证金时，通常并不需要偿付所有债务（从而卖出更多抵押）。

在[BSIP 31](https://github.com/bitshares/bsips/blob/master/bsip-0031.md)到位后，空头将有更多机会在追加保证金时不偿付所有债务，但这并不是100％保证的，他们只能被动地接受结果。

## 基本原理 ##

当追加保证金时，不同的空头有不同的预期：

- 有些人想完全关闭空头头寸以减少损失;
- 有些人希望尽可能少的出售抵押，以尽可能保持剩余的空头头寸;
- 有些人希望出售超过最低要求的抵押，以减少在不久的将来再次追加保证金的可能性，但不希望完全平仓。

通过新的“目标抵押比率”选项，所有这些预期都可以实现。

在下面的部分中，“追加保证金订单”和“追加单”均表示追加保证金区域的空头头寸。

### 目标抵押比率的定义 ###

为便于参考，任何给定债务/空头头寸的抵押比率描述了可用抵押（例如核心代币BTS）与原借款人对区块链所欠债务（例如，人民币等）之间的比率。它被定义为无量纲值，如CR =抵押/（债务/喂价），其中价格以债务资产/抵押资产单位（例如CNY / BTS）为单位计量。

“目标抵押比率”是一个可选值，可以设置为空头头寸，当头寸自动清算（追加保证金）时，卖出不超过所需的抵押，直到头寸的抵押比率高于此值。

- 默认值：未设置，这意味着尽可能多地出售抵押，这与当前行为相同。
- 当设置值低于MCR时，使用MCR。
- 将追加保证金订单与强制清算订单匹配时，忽略此选项。
- 检查黑天鹅或全局清算时，忽略此选项。

为什么使用“高于”而不是“等于”，是因为现有的一个规则：如果空头头寸的抵押比率等于MCR，仍然会追加保证金。

### 数学 ###

下面描述的价格以债务/抵押为例，例如： 每个BTS多少人民币。

追加保证金订单可以与作为挂单或吃单的限价单匹配，无论是挂单或吃单都会有匹配价格。 我们可以解这个方程：

       target_CR = new_collateral / ( new_debt / feed_price )
      = ( collateral - max_amount_to_sell ) * feed_price
    / ( debt - amount_to_get )
      = ( collateral - max_amount_to_sell ) * feed_price
    / ( debt - max_amount_to_sell * match_price )
    =>
    max_amount_to_sell = (debt * target_CR - collateral * feed_price)
     / (target_CR * match_price - feed_price)

结果是一个有理数。

那么，想要支偿付的最高债务可以计算为：

    max_debt_to_cover = max_amount_to_sell * match_price

结果也是一个有理数。

### 最大值计算的舍入 ###

如[BSIP 35](https://github.com/bitshares/bsips/blob/master/bsip-0035.md)中所述，最后我们需要将有理数转换为整数，因此涉及四舍五入的问题。

**第一轮**

在计算要偿付的最大债务时，目的是超出指定目标但不会超出太多。也就是说，如果空头头寸与大限价单匹配，在部分成交后，其抵押比率应该高于指定的目标抵押比率。

我们可以这样计算：如果max_debt_to_cover没有小数部分（例如5.00而不是5.23），加上一个Satoshi;否则，向上取整。一种有效的方法是向下取整然后结果加上一个Satoshi：

    max_debt_to_cover_int = round_down（max_debt_to_cover）+ 1

对于整数的max_debt_to_cover_int，整数中的max_amount_to_sell_int可以计算为：

    max_amount_to_sell_int = round_up（max_debt_to_cover_int / match_price）

值得注意的是，我们需要确保2个整数总是成对的，它们要么是全部抵押金额和全额债务金额，要么：

    max_amount_to_sell_int == round_up（max_debt_to_cover_int / match_price）
    max_debt_to_cover_int == round_down（max_amount_to_sell_int * match_price）

对于上面的max_amount_to_sell_int，我们可以调整max_debt_to_cover_int：

    max_debt_to_cover_int = round_down（max_amount_to_sell_int * match_price）

**查看结果**

由于四舍五入的关系，不能保证卖出更多抵押总会在剩余追加单中产生更高的抵押比率。

一方面，不能保证上面的整数对符合要求：在偿付max_debt_to_cover_int之后，剩余订单的抵押比率仍然不高于MCR或target_CR。在这种情况下，结果是不可接受的。通常，如果我们向上搜索，我们可以找到符合要求的新整数对，或者达到订单的抵押或债务金额。

另一方面，无论上述整数对是否满足抵押比率的要求，都可能存在符合要求的较小的整数对。然而，要找到一个最佳配对并不容易。如果我们向下搜索，那么很难决定何时停止搜索;如果我们从较小的整数对开始然后向上搜索，那么很难决定从哪里开始搜索。

**性能优于准确性**

由于上面提到的这些困难，在这个BSIP中我们允许不完美的结果，并且没有描述或执行如何准确地找到更好的结果。

首先要努力落实。经股东表决通过后形成共识。它将一直有效，直到更改或替换为新的BSIP。

以下是一些实施的指南。

当向上搜索时，通常真正有效的整数对就在不远处，但由于四舍五入的关系不能保证出现。为了获得更好的性能，每增加一个Satoshi进行搜索的效果并不好。可以使用分散序列或其他次线性时间算法，这意味着可能会跳过一些好的数据，从而导致结果的不完善。

### 订单匹配的舍入和边缘案例 ###

[BSIP 35中](https://github.com/bitshares/bsips/blob/master/bsip-0035.md)中定义了订单匹配的舍入规则。

通常，当两个订单匹配时，订单匹配引擎在舍入时更倾向于匹配较大的订单。

当追加单与限价单匹配时，如果追加单没有设置target_CR选项但其债务超过限价单所提供的债务，或者追加单设置了target_CR选项但max_debt_to_cover_int超过了限价单提供的债务，这都意味着追加单更大，根据舍入规则，追加单偿付的抵押将向下取整，因此其抵押比率将在部分成交后有所提高。

如果追加单设置了target_CR选项并且偿付了整个“待偿付的最大债务”，公平地说，我们应该考虑较小的部分追加单并且在舍入时倾向于匹配限价单，否则限价单可能遭受整体损失。这意味着追加单将被部分成交，其偿付的抵押将被向上取整，在这种情况下，如果追加单的抵押比率不是太低，通常，部分成交仍将导致抵押比率的提高。

然而，存在边缘情况：如果追加单的抵押比率已经很低，或者其债务或抵押金额很小，那么部分成交的已偿付的抵押的向上取整可能会导致抵押比率下降，极端情况下甚至可能导致黑天鹅事件。这违反了本BSIP的意图。为了解决这个问题，如果在匹配时检测到抵押比率下降，我们建议忽略相应追加单的target_CR选项，并重新评估匹配。

### 关于订单匹配的修订舍入规则 ###

因此，限价单与追加单匹配的规则将按照以下粗体新规则进行修订：

- 如果追加单收到全部债务金额，这意味着它较小，并且在匹配结束后空头头寸将被平仓，向上取整其支付金额;
- **除此以外**，
	- **如果追加单设置了target_collat​​eral_ratio并且正在接收使用target_collat​​eral_ratio计算的最大债务金额，则追加单较小，向上取整其支付金额;**
		- **对于边缘情况，如果由于向上取整（在极端情况下甚至可能导致黑天鹅事件）后追加单的抵押比率在部分成交后没有提高，则将此target_collat​​eral_ratio视为“未设置”，重新应用此匹配的成交规则。**
	- 否则，追加单较大，向下取整其支付金额。
		- 如果限价单没有收到任何东西，取消它（它较小，所以可以安全取消）;
		- 否则，计算限价单支付的金额为round_up（receiving_amount * match_price）。在两个订单成交后，如果限价单仍然存在，则剩余金额可能太小，因此取消它。

### 何时以及如何使用该选项 ###

创建或更新空头头寸时，可以设置、更新或清除target_collat​​eral_ratio选项。这样做时，其他规则仍然适用，例如，不能更新空头头寸，使其抵押比率太低。

对于一个账户，可以使用不同的target_collat​​eral_ratio设置不同的空头头寸（针对不同的资产）。

对于一个空头头寸，

- 如果追加保证金时想要完全平仓空头头寸以减少损失，
	- 不设置或清除target_collat​​eral_ratio选项，因为该选项是可选的，因此可以取消设置或被清除;
- 如果追加保证金时想尽可能少地出售抵押，以保持剩余的空头头寸尽可能大，
	- 将target_collat​​eral_ratio设置为MCR或更低;
- 如果想在追加保证金时卖出超过最低要求的抵押，以减少在不久的将来再次追加保证金的可能性，但不想完全平仓空头头寸，
	- 将target_collat​​eral_ratio设置为高于MCR的值，例如 300％。值越高，当追加保证金时就会有更多的抵押被挂单出售。

## 详情 ##

### call_order_object ###

call_order_object存储空头头寸的当前状态。

需要在其中添加新字段：

- 可选<uint16_t> target_collateral_ratio;


与其他抵押比率相同，实际比率是除以GRAPHENE_COLLATERAL_RATIO_DENOM(即10000)的值。

由于uint16_t数据类型，新字段的最大值为65535，这意味着6553.5％。

### call_order_update_operation ###

call_order_update_operation用于打开、更新和关闭空头头寸。 它包含一个扩展字段：

- extensions_type扩展;

需要覆盖此字段的数据类型，以便它可以包含新的“目标抵押比率”选项。

### call_order_update_evaluator ###

call_order_update_evaluator用于评估和应用call_order_udpate_operation。 需要添加逻辑：

- 只允许在硬分叉后设置target_collateral_ratio;
- 相应地设置/更新/清除call_order_object的target_collateral_ratio字段。 特别地，
	- 如果字段在操作中出现并且有效，则设置或更新该字段，
	- 如果该字段在操作中不存在或无效，则清除该字段。

### proposal_create_evaluator ###

proposal_create_evaluator用于评估和应用proposal_create_operation，它可以包含零个或多个call_order_udpate_operation对象。 需要添加逻辑：

- 只允许在硬分叉后设置target_collateral_ratio。

### 匹配和成交追加单 ###

在追加单与限价单匹配后并即将成交时，

- 如果没有设置target_collateral_ratio，则像以前一样处理;
- 如果设置了target_collateral_ratio，则将其与MCR进行比较，使用较大的一个（即 max（target_collateral_ratio，MCR））根据上述等式计算要待偿付的最大债务金额，并应用修订的舍入规则，然后像之前那样处理其他逻辑。

### UI/UX ###

需要显示新选项，并且可以在硬分叉后在UI中使用。

当存在待成交的追加单时，如果设置了target_collateral_ratio选项，则UI需要显示另一个交易者能够购买的确切数量的抵押金额，以及根据上述等式需要偿付的确切债务金额。 请注意，此计算需要使用当前的feed_price。

## 讨论 ##

有了这个BSIP，我们提供了一个空头可用来保持其头寸的工具，但是，这并不总是保持尽可能大的头寸的最佳策略，有时它的风险甚至比简单地减少损失更大。 尽管如此，如何使用该工具，取决于交易者的决定。

## 股东总结 ##

“这就是它应该如何运作的。”

## 版权 ##

本文档放置于公共域名下。

## 查看 ##

- [https://bitsharestalk.org/index.php?topic=25924.0](https://bitsharestalk.org/index.php?topic=25924.0)
- [https://github.com/bitshares/bsips/issues/51](https://github.com/bitshares/bsips/issues/51)