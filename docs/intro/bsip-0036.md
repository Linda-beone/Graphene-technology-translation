原文链接：https://github.com/bitshares/bsips/blob/master/bsip-0036.md
译者：bt666

    BSIP:0036
    标题:删除维护周期内的到期喂价
    作者:oxarbitrage < https://github.com/oxarbitrage >
    状态:安装
    类型:协议
    创建:2018-02-22
    讨论:https://bitsharestalk.org/index.php?topic=25996.0
    替换:
    预算提案:1.14.97

## 摘要 ##

目前，过期的比特资产喂价永远存在于区块链中。要删除它们，唯一的方法是在资产上通过新的发布者调用update_feed_producers这一操作。在这个调用中，也只有在这种情况下，旧的发布者喂价将从区块链中删除。如果该操作从未发生，或者出现维护某些或所有相同的发布者喂价的情况，则该喂价不会被删除。

以下是一些例子，我们可以看到2015年的喂价:

- [http://open-explorer.io/#/objects/2.4.9](http://open-explorer.io/#/objects/2.4.9) HKD
- [http://open-explorer.io/#/objects/2.4.21](http://open-explorer.io/#/objects/2.4.21) USD
- [http://open-explorer.io/#/objects/2.4.10](http://open-explorer.io/#/objects/2.4.10) RUB
- 等。

此BSIP建议对协议进行更改，以便在维护时删除过期的喂价。

## 动机 ##

改进bitshares-core的性能

## 基本原理 ##

建议的更改只会在喂价过期时间增加时影响喂价。这种情况很少发生(如果有的话)，因此在实践中对定价的影响可以忽略不计。然而，对性能的改进不可忽略。

## 详情 ##

正如在摘要中所说的，喂价会永久性的保持在区块链中，除非调用asset_update_feed_producers_evaluator::do_apply

该BSIP建议在维护时通过在db_main.cpp中添加喂价清除代码来删除过期的喂价。

解决方案并不是那么简单，asset_update_bitasset_operation可以更改资产所需的feed_expiration_time和minimum_feeds。

如果喂价过期了，且feed_expiration_time发生了更改，那么过期的喂价可能变为有效，类似于如果minimum_feeds(需要计算中位数)增加了，旧的喂价可能变为有效，可用的情况下还会被核心市场引擎使用。

这种情况实际上过去发生过。这就是除非添加了硬分叉保护，否则更改将失败的原因。

### 建议的解决方案 ###

目标是以安全的方式删除过期的喂价。要做到这一点，我们需要在硬分叉日期之前保持当前行为，并且只在硬分叉之后的维护周期中删除喂价。这将允许链在所有喂价有效时进行同步并开始清理喂价，从那时起可以安全地将它们删除并继续清理。

这是一个永久的硬分叉，在硬分叉日期之前的代码将以某种方式执行(当前行为)，而在硬分叉日期之后的新代码将以不同的方式工作，从而在维护时进行喂价的清理。

喂价清理代码只会在提议的硬分叉日期后执行，在日期后的第一个维护周期内旧的喂价将被删除，节点将不能再使用它们，因为它们在数据库中不可用。

如果在硬分叉操作恢复正常之前调用asset_update_bitasset_operation是正常的，因为当前来说是现在。

如果asset_update_bitasset_operation是在硬分叉之后调用的，并且增加了minimum_feeds。而它们没有足够的喂价，那么update_median_feeds()将设置一个空的喂价。这就是当前的asset_update_bitasset_operation，不需要在操作中做任何更改。

## 讨论 ##

[https://bitsharestalk.org/index.php?topic=25996.0](https://bitsharestalk.org/index.php?topic=25996.0)

## 股东总结 ##

[如果有，再添加]

## 版权 ##

本文档放置于公共域名下。

## 查看 ##

- [https://github.com/bitshares/bitshares-core/issues/518](https://github.com/bitshares/bitshares-core/issues/518)
- [https://github.com/bitshares/bitshares-core/pull/598](https://github.com/bitshares/bitshares-core/pull/598)